name: Build and publish fpk for multiple architectures

on:
  push:
    tags:
      - '*'
  workflow_dispatch: {}

permissions:
  contents: write

env:
  NODE_VERSION: "18"
  PYTHON_VERSION: '3.11'

jobs:  
  # 主 job，负责设置变量
  setup:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set-tag.outputs.tag }}
      prerelease: ${{ steps.set-tag.outputs.prerelease }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set tag and prerelease info
        id: set-tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF##*/}"
          else
            TAG="run-${GITHUB_RUN_NUMBER}"
          fi
          
          if [[ "$TAG" == run-* ]] || [[ "${TAG}" == *dev* ]] || [[ "${TAG}" == *pre* ]] || [[ "${TAG}" == *beta* ]]; then
            PRE=true
          else
            PRE=false
          fi
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "prerelease=$PRE" >> $GITHUB_OUTPUT

  build-multi-arch:
    needs: setup
    strategy:
      matrix:
        include:
          - arch: linux-amd64
            runner: ubuntu-latest
          - arch: linux-arm64
            runner: ubuntu-latest-arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run build
        run: |          
          chmod +x ./fnpack.sh 2>/dev/null || true
          chmod +x ./build.sh 2>/dev/null || true
          ./build.sh arch=${{ matrix.arch }} build_pre="${{ needs.setup.outputs.prerelease }}" 2>/dev/null || true

      - name: Prepare artifact
        run: |
          FPK_FILE=$(ls *.fpk 2>/dev/null | head -1)
          if [ -z "$FPK_FILE" ]; then
            echo "错误：未找到.fpk文件"
            ls -la
            exit 1
          fi
          
          mkdir -p release
          if [ "${{ needs.setup.outputs.prerelease }}" == "true" ]; then
            # 正式版去除版本号
            NEW_FPK_NAME="OpenList-${{ matrix.arch }}.fpk"
            cp "$FPK_FILE" "release/$NEW_FPK_NAME"
          echo "准备完成: $NEW_FPK_NAME"
          else
            cp "$FPK_FILE" "release/$FPK_FILE"
            echo "准备完成: $FPK_FILE"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fpk-${{ matrix.arch }}
          path: release/
          retention-days: 1

  create-release:
    needs: 
      - setup
      - build-multi-arch
    runs-on: ubuntu-latest
    steps:
      - name: Create release directory
        run: |
          mkdir -p combined-release
    
      - name: Download amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: fpk-amd64
          path: combined-release
          
      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: fpk-arm64
          path: combined-release

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.setup.outputs.tag }}
          name: ${{ needs.setup.outputs.tag }}
          artifacts: "combined-release/*"
          prerelease: ${{ needs.setup.outputs.prerelease }}
          skipIfReleaseExists: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release summary
        if: always()
        run: |
          echo "=== 发布总结 ==="
          echo "版本: ${{ needs.setup.outputs.tag }}"
          echo "预发布: ${{ needs.setup.outputs.prerelease }}"
          echo "包含的文件:"
          ls -la combined-release/
          echo "================"